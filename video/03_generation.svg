<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 450" font-family="'Courier New', monospace">

  <defs>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="3" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <filter id="textGlow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="2" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <linearGradient id="loopGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#4fc3f7"/>
      <stop offset="100%" stop-color="#76ff03"/>
    </linearGradient>
  </defs>

  <style>
    .bg { fill: #1a1a2e; }

    /* Title */
    .title {
      fill: #e0e0e0; font-size: 24px; font-weight: bold;
      opacity: 0;
      animation: fadeIn 0.8s ease 0.3s forwards;
    }
    .subtitle {
      fill: #888; font-size: 14px;
      opacity: 0;
      animation: fadeIn 0.8s ease 0.8s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; } }

    /* Loop diagram */
    .loop-box {
      fill: #2a2a4e;
      stroke: #4fc3f7;
      stroke-width: 2;
      rx: 8;
      opacity: 0;
    }
    .loop-label {
      fill: #e0e0e0;
      font-size: 13px;
      text-anchor: middle;
      opacity: 0;
    }

    .lb1 { animation: popIn 0.5s ease 1.2s forwards; }
    .lb2 { animation: popIn 0.5s ease 1.8s forwards; }
    .lb3 { animation: popIn 0.5s ease 2.4s forwards; }
    .lb4 { animation: popIn 0.5s ease 3.0s forwards; }

    .ll1 { animation: fadeIn 0.3s ease 1.5s forwards; }
    .ll2 { animation: fadeIn 0.3s ease 2.1s forwards; }
    .ll3 { animation: fadeIn 0.3s ease 2.7s forwards; }
    .ll4 { animation: fadeIn 0.3s ease 3.3s forwards; }

    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.8); }
      70% { transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* Arrows */
    .loop-arrow {
      fill: none;
      stroke: #4fc3f7;
      stroke-width: 2;
      stroke-dasharray: 60;
      stroke-dashoffset: 60;
      marker-end: url(#arrowhead);
    }
    .la1 { animation: drawArrow 0.4s ease 1.6s forwards; }
    .la2 { animation: drawArrow 0.4s ease 2.2s forwards; }
    .la3 { animation: drawArrow 0.4s ease 2.8s forwards; }

    @keyframes drawArrow { to { stroke-dashoffset: 0; } }

    /* Return arrow (curved) */
    .return-arrow {
      fill: none;
      stroke: #76ff03;
      stroke-width: 2;
      stroke-dasharray: 200;
      stroke-dashoffset: 200;
      marker-end: url(#arrowheadGreen);
    }
    .return-anim { animation: drawReturn 0.8s ease 3.5s forwards; }
    @keyframes drawReturn { to { stroke-dashoffset: 0; } }

    .repeat-label {
      fill: #76ff03;
      font-size: 11px;
      opacity: 0;
      animation: fadeIn 0.5s ease 4s forwards;
    }

    /* Generated text area */
    .text-box {
      fill: #1e1e3a;
      stroke: #555;
      stroke-width: 1;
      rx: 6;
      opacity: 0;
      animation: fadeIn 0.6s ease 4.5s forwards;
    }
    .text-label {
      fill: #888;
      font-size: 11px;
      opacity: 0;
      animation: fadeIn 0.5s ease 4.8s forwards;
    }

    /* Character-by-character text generation */
    .gen-char {
      fill: #ffd700;
      font-size: 18px;
      opacity: 0;
      filter: url(#textGlow);
    }

    /* Staggered character reveals - Shakespeare quote */
    .c1  { animation: charPop 0.15s ease 5.0s forwards; }
    .c2  { animation: charPop 0.15s ease 5.15s forwards; }
    .c3  { animation: charPop 0.15s ease 5.30s forwards; }
    .c4  { animation: charPop 0.15s ease 5.45s forwards; }
    .c5  { animation: charPop 0.15s ease 5.60s forwards; }
    .c6  { animation: charPop 0.15s ease 5.75s forwards; }
    .c7  { animation: charPop 0.15s ease 5.90s forwards; }
    .c8  { animation: charPop 0.15s ease 6.05s forwards; }
    .c9  { animation: charPop 0.15s ease 6.20s forwards; }
    .c10 { animation: charPop 0.15s ease 6.35s forwards; }
    .c11 { animation: charPop 0.15s ease 6.50s forwards; }
    .c12 { animation: charPop 0.15s ease 6.65s forwards; }
    .c13 { animation: charPop 0.15s ease 6.80s forwards; }
    .c14 { animation: charPop 0.15s ease 6.95s forwards; }
    .c15 { animation: charPop 0.15s ease 7.10s forwards; }
    .c16 { animation: charPop 0.15s ease 7.25s forwards; }
    .c17 { animation: charPop 0.15s ease 7.40s forwards; }
    .c18 { animation: charPop 0.15s ease 7.55s forwards; }
    .c19 { animation: charPop 0.15s ease 7.70s forwards; }
    .c20 { animation: charPop 0.15s ease 7.85s forwards; }
    .c21 { animation: charPop 0.15s ease 8.00s forwards; }
    .c22 { animation: charPop 0.15s ease 8.15s forwards; }
    .c23 { animation: charPop 0.15s ease 8.30s forwards; }
    .c24 { animation: charPop 0.15s ease 8.45s forwards; }

    @keyframes charPop {
      0% { opacity: 0; transform: scale(1.5); fill: #fff; }
      50% { fill: #fff; }
      100% { opacity: 1; transform: scale(1); fill: #ffd700; }
    }

    /* Cursor blink */
    .cursor {
      fill: #ffd700;
      animation: blink 0.6s step-end infinite 5s;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* Code overlay */
    .code-overlay {
      fill: #76ff03;
      font-size: 14px;
      opacity: 0;
      animation: codeIn 1s ease 9s forwards;
    }
    .code-dim {
      fill: #888;
      font-size: 14px;
      opacity: 0;
      animation: fadeIn 0.8s ease 9.2s forwards;
    }
    @keyframes codeIn {
      0% { opacity: 0; letter-spacing: 3px; }
      100% { opacity: 0.9; letter-spacing: 0; }
    }

    /* Probability bars */
    .prob-bar {
      fill: #4fc3f7;
      opacity: 0;
    }
    .prob-label {
      fill: #888;
      font-size: 9px;
      opacity: 0;
    }
    .pb1 { animation: barGrow 0.3s ease 5.0s forwards; }
    .pb2 { animation: barGrow 0.3s ease 5.15s forwards; }
    .pb3 { animation: barGrow 0.3s ease 5.3s forwards; }

    @keyframes barGrow {
      0% { opacity: 0; transform: scaleX(0); }
      100% { opacity: 0.7; transform: scaleX(1); }
    }
  </style>

  <!-- Arrowheads -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4fc3f7"/>
    </marker>
    <marker id="arrowheadGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#76ff03"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect class="bg" width="800" height="450" rx="8"/>

  <!-- Title -->
  <text class="title" x="400" y="40" text-anchor="middle">Token Generation</text>
  <text class="subtitle" x="400" y="62" text-anchor="middle">The autoregressive sampling loop</text>

  <!-- Loop diagram: Predict -> Sample -> Append -> [loop back] -->
  <g transform="translate(100, 100)">
    <!-- Box 1: Context -->
    <rect class="loop-box lb1" x="0" y="20" width="100" height="50"/>
    <text class="loop-label ll1" x="50" y="50">Context</text>

    <!-- Arrow 1 -->
    <path class="loop-arrow la1" d="M 105 45 L 145 45"/>

    <!-- Box 2: Predict -->
    <rect class="loop-box lb2" x="150" y="20" width="100" height="50"/>
    <text class="loop-label ll2" x="200" y="50">Predict</text>

    <!-- Arrow 2 -->
    <path class="loop-arrow la2" d="M 255 45 L 295 45"/>

    <!-- Box 3: Sample -->
    <rect class="loop-box lb3" x="300" y="20" width="100" height="50"/>
    <text class="loop-label ll3" x="350" y="50">Sample</text>

    <!-- Arrow 3 -->
    <path class="loop-arrow la3" d="M 405 45 L 445 45"/>

    <!-- Box 4: Append -->
    <rect class="loop-box lb4" x="450" y="20" width="100" height="50"/>
    <text class="loop-label ll4" x="500" y="50">Append</text>

    <!-- Return arrow (curved, goes below) -->
    <path class="return-arrow return-anim" d="M 500 75 L 500 100 Q 500 115 485 115 L 65 115 Q 50 115 50 100 L 50 75"/>

    <text class="repeat-label" x="275" y="130" text-anchor="middle">repeat</text>
  </g>

  <!-- Probability visualization -->
  <g transform="translate(620, 120)" opacity="0.8">
    <text fill="#666" font-size="10" x="0" y="0">next token probs:</text>
    <rect class="prob-bar pb1" x="0" y="8" width="60" height="12" rx="2"/>
    <text class="prob-label pb1" x="65" y="18">"T" 0.31</text>
    <rect class="prob-bar pb2" x="0" y="24" width="35" height="12" rx="2"/>
    <text class="prob-label pb2" x="65" y="34">"W" 0.18</text>
    <rect class="prob-bar pb3" x="0" y="40" width="25" height="12" rx="2"/>
    <text class="prob-label pb3" x="65" y="50">"I" 0.12</text>
  </g>

  <!-- Generated text display -->
  <rect class="text-box" x="100" y="260" width="600" height="100" rx="8"/>
  <text class="text-label" x="110" y="255">Generated output:</text>

  <!-- Character by character generation: "To be or not to be..." -->
  <g transform="translate(120, 310)">
    <text class="gen-char c1" x="0" y="0">T</text>
    <text class="gen-char c2" x="12" y="0">o</text>
    <text class="gen-char c3" x="24" y="0"> </text>
    <text class="gen-char c4" x="36" y="0">b</text>
    <text class="gen-char c5" x="48" y="0">e</text>
    <text class="gen-char c6" x="60" y="0">,</text>
    <text class="gen-char c7" x="72" y="0"> </text>
    <text class="gen-char c8" x="84" y="0">o</text>
    <text class="gen-char c9" x="96" y="0">r</text>
    <text class="gen-char c10" x="108" y="0"> </text>
    <text class="gen-char c11" x="120" y="0">n</text>
    <text class="gen-char c12" x="132" y="0">o</text>
    <text class="gen-char c13" x="144" y="0">t</text>
    <text class="gen-char c14" x="156" y="0"> </text>
    <text class="gen-char c15" x="168" y="0">t</text>
    <text class="gen-char c16" x="180" y="0">o</text>
    <text class="gen-char c17" x="192" y="0"> </text>
    <text class="gen-char c18" x="204" y="0">b</text>
    <text class="gen-char c19" x="216" y="0">e</text>
    <text class="gen-char c20" x="228" y="0">:</text>
    <text class="gen-char c21" x="240" y="0"> </text>
    <text class="gen-char c22" x="252" y="0">t</text>
    <text class="gen-char c23" x="264" y="0">h</text>
    <text class="gen-char c24" x="276" y="0">a</text>

    <!-- Blinking cursor -->
    <rect class="cursor" x="290" y="-14" width="10" height="18"/>
  </g>

  <!-- Second line hint -->
  <text x="120" y="340" fill="#666" font-size="12" opacity="0" style="animation: fadeIn 0.5s ease 9s forwards;">
    t is the question...
  </text>

  <!-- Code overlay -->
  <text class="code-overlay" x="400" y="405" text-anchor="middle">model.generate()</text>
  <text class="code-dim" x="400" y="422" text-anchor="middle">idx = model.generate(idx, max_new_tokens=100)</text>

  <!-- Decorative corners -->
  <g opacity="0.3">
    <path fill="none" stroke="#4fc3f7" stroke-width="1" d="M 20 20 L 20 40 M 20 20 L 40 20"/>
    <path fill="none" stroke="#4fc3f7" stroke-width="1" d="M 780 20 L 780 40 M 780 20 L 760 20"/>
    <path fill="none" stroke="#4fc3f7" stroke-width="1" d="M 20 430 L 20 410 M 20 430 L 40 430"/>
    <path fill="none" stroke="#4fc3f7" stroke-width="1" d="M 780 430 L 780 410 M 780 430 L 760 430"/>
  </g>

</svg>
